<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Patintero Game</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
html,body { height: 100%; margin:0; padding:0; }
body {
font-family: "Press Start 2P", cursive;
background: url("patintero-bg.png") no-repeat center center fixed;
background-size: cover;
overflow: hidden;
}

.overlay-card {
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
width: 90vw;
max-width: 600px;
background: rgba(0,0,0,0.2);
backdrop-filter: blur(5px);
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
text-align: center;
padding: 5vw;
z-index: 100;
}

.overlay-card h2 {
margin-top: 0;
color: yellow;
font-size: 5vw;
letter-spacing: 2px;
text-shadow: 2px 2px 0 #000;
}

.overlay-card p {
font-size: 3vw;
margin: 5vw 0;
line-height: 1.6em;
color: #fff;
text-shadow: 1px 1px 0 #000;
max-width: 90vw;
}

.overlay-card ul {
text-align: left;
color: #fff;
font-size: 2.5vw;
max-width: 80%;
margin: 2vw 0;
list-style: none;
padding: 0;
}

.overlay-card li {
margin: 1vw 0;
text-shadow: 1px 1px 0 #000;
}

.overlay-card input {
padding: 3vw;
font-size: 3vw;
width: 70%;
margin: 2vw 0;
border: 2px solid #fff;
border-radius: 8px;
background: rgba(255,255,255,0.9);
font-family: inherit;
text-align: center;
}

#startBtn, .submit-btn, #leaderboardBtn {
padding: 3vw 6vw;
font-size: 3vw;
background: #2196f3;
color: #fff;
border: none;
border-radius: 8px;
cursor: pointer;
transition: all 0.18s ease;
box-shadow: 0 4px 0 #0d47a1;
z-index: 101;
pointer-events: auto;
margin: 2vw 0;
}

#leaderboardBtn {
background: #4caf50;
box-shadow: 0 4px 0 #388e3c;
}

#startBtn:hover, .submit-btn:hover, #leaderboardBtn:hover {
transform: scale(1.06);
}

#leaderboardBtn:hover {
background: #45a049;
}

/* UI Elements */
.top-ui {
  position: fixed;
  top: 10px;
  z-index: 1000;
  color: white;
  text-shadow: 1px 1px 0 black;
  font-size: clamp(8px, 2vw, 16px);
  line-height: 1.2;
}

#ui-left {
  left: 10px;
}

#ui-right {
  right: 10px;
  text-align: right;
}

#ui-right h3 {
  color: yellow;
  font-size: clamp(12px, 4vw, 24px);
  margin: 0;
  letter-spacing: 2px;
}

/* CHARACTER SPRITE SYSTEM */
:root {
--pixel-size: 2;
}

.Character {
width: calc(32px * var(--pixel-size));
height: calc(32px * var(--pixel-size));
overflow: hidden;
position: absolute;
}

.Character_spritesheet {
animation: moveSpritesheet 1s steps(4) infinite;
width: calc(128px * var(--pixel-size));
position: absolute;
}
.Character_shadow {
position: absolute;
width: calc(32px * var(--pixel-size));
height: calc(32px * var(--pixel-size));
}

.pixelart {
image-rendering: pixelated;
}

.face-down { top: 0; }
.face-right { top: calc(-32px * var(--pixel-size)); }
.face-up { top: calc(-64px * var(--pixel-size)); }
.face-left { top: calc(-96px * var(--pixel-size)); }

@keyframes moveSpritesheet {
from { transform: translate3d(0px,0,0) }
to { transform: translate3d(-100%,0,0) }
}
</style>
</head>
<body>
<!-- Home Screen -->
<div class="overlay-card" id="homeScreen">
<h2>Patintero</h2>
<p>
üèÉ Relive the excitement of a Filipino
childhood favorite! Cross the lines and avoid the taggers.<br><br>
üëâ Use <b>ARROW KEYS / WASD</b> or <b>TAP/CLICK</b> to move.<br>
üèÅ Reach the opposite side without being tagged!
</p>
<button id="startBtn">‚ñ∂ START GAME</button>
<button id="leaderboardBtn">üèÜ Leaderboard</button>
</div>
<script>
document.addEventListener("DOMContentLoaded", () => {
const startBtn = document.getElementById("startBtn");
const leaderboardBtn = document.getElementById("leaderboardBtn");
let playerName = '';
let currentLevel = 1;
let maxLevel = 5;
let gameEnded = false;
let x, y;
let screenW, screenH;
let blockers = [];
let linesY = [];

// ApiLeaderboard functions
function getLeaderboard() {
  return JSON.parse(localStorage.getItem('patinteroLeaderboard') || '[]');
}

function saveLeaderboard(leaderboard) {
  localStorage.setItem('patinteroLeaderboard', JSON.stringify(leaderboard));
}

function updatePlayerScore(name, levelsCompleted) {
  let lb = getLeaderboard();
  const completed = Math.max(0, levelsCompleted);
  let existing = lb.find(p => p.name.toLowerCase() === name.toLowerCase());
  if (existing) {
    if (completed > existing.levelsCompleted) {
      existing.levelsCompleted = completed;
    }
  } else {
    lb.push({ name: name, levelsCompleted: completed });
  }
  lb.sort((a, b) => b.levelsCompleted - a.levelsCompleted || a.name.localeCompare(b.name));
  saveLeaderboard(lb);
}

function showLeaderboard() {
  const lb = getLeaderboard();
  const top10 = lb.slice(0, 10);
  let html = '<h2>üèÜ Leaderboard</h2><p>Top 10 Players by Levels Completed</p><ul>';
  if (top10.length === 0) {
    html += '<li>No scores yet!</li>';
  } else {
    top10.forEach((p, i) => {
      html += `<li>${i + 1}. ${p.name} - ${p.levelsCompleted} Levels</li>`;
    });
  }
  html += '</ul><button class="submit-btn" id="closeLb">Close</button>';
  const lbOverlay = document.createElement("div");
  lbOverlay.className = "overlay-card";
  lbOverlay.id = "lbOverlay";
  lbOverlay.innerHTML = html;
  document.body.appendChild(lbOverlay);
  document.getElementById("closeLb").addEventListener("click", () => {
    lbOverlay.remove();
  });
}

leaderboardBtn.addEventListener("click", showLeaderboard);

startBtn.addEventListener("click", () => {
  document.getElementById("homeScreen").style.display = "none";

  // Username Input Overlay
  const nameOverlay = document.createElement("div");
  nameOverlay.className = "overlay-card";
  nameOverlay.id = "nameOverlay";
  nameOverlay.innerHTML = `
    <h2>Enter Player Name</h2>
    <p>To start the game, please enter your username.</p>
    <input id="username" type="text" placeholder="Your Name" maxlength="20">
    <button class="submit-btn" id="submitName">‚ñ∂ START GAME</button>
  `;
  document.body.appendChild(nameOverlay);

  const submitNameBtn = document.getElementById("submitName");
  const usernameInput = document.getElementById("username");

  submitNameBtn.addEventListener("click", () => {
    const name = usernameInput.value.trim();
    if (!name) {
      alert("Please enter a username to start the game!");
      return;
    }
    playerName = name;

    // Store in JSON for API (localStorage example; can be sent to API later)
    const playerData = {
      name: playerName,
      currentLevel: currentLevel,
      maxLevel: maxLevel
    };
    localStorage.setItem('patinteroPlayer', JSON.stringify(playerData));

    nameOverlay.remove();

    // Initialize Game
    initGame();
  });

  // Allow Enter key for username
  usernameInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      submitNameBtn.click();
    }
  });
});

function initGame() {
  screenW = window.innerWidth;
  screenH = window.innerHeight;

  document.body.style.background = "url('playground.png') no-repeat center center fixed";
  document.body.style.backgroundSize = "cover";

  // UI Elements
  const uiLeft = document.createElement("div");
  uiLeft.id = "ui-left";
  uiLeft.className = "top-ui";
  uiLeft.innerHTML = '<div id="playerInfo"></div>';
  document.body.appendChild(uiLeft);

  const uiRight = document.createElement("div");
  uiRight.id = "ui-right";
  uiRight.className = "top-ui";
  uiRight.innerHTML = '<h3>PATINTERO</h3>';
  document.body.appendChild(uiRight);

  updatePlayerInfo();

  // Lines for blockers (from bottom to top)
  linesY = [
    screenH * 0.75,
    screenH * 0.60,
    screenH * 0.45,
    screenH * 0.30,
    screenH * 0.15
  ];

  // === PLAYER SPRITE ===
  const player = document.createElement("div");
  player.className = "Character";
  x = screenW * 0.5;
  y = screenH * 0.85;
  player.style.left = x + "px";
  player.style.top = y + "px";
  player.setAttribute("facing", "down");
  player.innerHTML = `
    <img class="Character_shadow pixelart" src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/21542/DemoRpgCharacterShadow.png" />
    <img class="Character_spritesheet pixelart face-down" src="AjFP5.png" />
  `;
  document.body.appendChild(player);

  // Create initial blockers
  createBlockersForLevel(currentLevel);

  // === PLAYER MOVEMENT ===
  gameEnded = false;

  function movePlayer(dx, dy, direction) {
    if (gameEnded) return;
    x += dx;
    y += dy;
    // Bounds
    const playerSize = 64; // 32 * 2
    x = Math.max(0, Math.min(screenW - playerSize, x));
    y = Math.max(0, Math.min(screenH - playerSize, y));
    const sprite = player.querySelector(".Character_spritesheet");
    sprite.className = `Character_spritesheet pixelart ${direction}`;
    player.style.left = x + "px";
    player.style.top = y + "px";
  }

  window.addEventListener("keydown", e => {
    if (gameEnded) return;
    if (e.key === "ArrowLeft" || e.key.toLowerCase() === "a") movePlayer(-20, 0, "face-left");
    if (e.key === "ArrowRight" || e.key.toLowerCase() === "d") movePlayer(20, 0, "face-right");
    if (e.key === "ArrowUp" || e.key.toLowerCase() === "w") movePlayer(0, -20, "face-up");
    if (e.key === "ArrowDown" || e.key.toLowerCase() === "s") movePlayer(0, 20, "face-down");
  });

  // Improved touch controls (relative to player position)
  document.body.addEventListener("touchstart", e => {
    if (gameEnded) return;
    e.preventDefault();
    const touchX = e.touches[0].clientX;
    const touchY = e.touches[0].clientY;
    const playerCenterX = x + 32;
    const playerCenterY = y + 32;
    const relX = touchX - playerCenterX;
    const relY = touchY - playerCenterY;
    if (Math.abs(relY) > Math.abs(relX)) {
      if (relY < 0) movePlayer(0, -20, "face-up");
      else movePlayer(0, 20, "face-down");
    } else {
      if (relX < 0) movePlayer(-20, 0, "face-left");
      else movePlayer(20, 0, "face-right");
    }
  });

  // Click/tap zones for movement (absolute screen zones)
  // Top third: up, bottom third: down, left half middle: left, right half middle: right
  function handleClickMove(e) {
    if (gameEnded) return;
    let clientX, clientY;
    if (e.touches && e.touches.length > 0) {
      clientX = e.touches[0].clientX;
      clientY = e.touches[0].clientY;
    } else {
      clientX = e.clientX;
      clientY = e.clientY;
    }
    if (clientY < screenH / 3) {
      // Top: move up
      movePlayer(0, -20, "face-up");
    } else if (clientY > (screenH * 2) / 3) {
      // Bottom: move down
      movePlayer(0, 20, "face-down");
    } else {
      // Middle horizontal strip: left or right
      if (clientX < screenW / 2) {
        movePlayer(-20, 0, "face-left");
      } else {
        movePlayer(20, 0, "face-right");
      }
    }
  }

  // Add click event for mouse
  document.body.addEventListener("click", handleClickMove);

  // Add mousedown for more responsive mouse input (optional, but adds immediacy)
  document.body.addEventListener("mousedown", handleClickMove);

  // === BLOCKER CHASE + GAME OVER ===
  setInterval(() => {
    if (gameEnded) return;

    const playerX = x;
    let tagged = false;

    blockers.forEach(blk => {
      const blockerX = parseInt(blk.style.left);
      const blockerY = parseInt(blk.style.top);
      const dx = playerX - blockerX;
      const dy = y - blockerY;
      const step = 20;

      let newBlockerX = blockerX;

      // Blocker moves left/right only
      if (Math.abs(dx) > step) {
        newBlockerX = blockerX + step * Math.sign(dx);
        blk.style.left = newBlockerX + "px";
      }

      // Keep blocker on the line
      blk.style.top = blockerY + "px";

      // Face towards player
      let faceDir;
      if (Math.abs(dy) > Math.abs(dx)) {
        faceDir = dy > 0 ? "face-down" : "face-up";
      } else {
        faceDir = dx > 0 ? "face-right" : "face-left";
      }
      const sprite = blk.querySelector(".Character_spritesheet");
      sprite.className = `Character_spritesheet pixelart ${faceDir}`;

      // Collision detection (using new position)
      const distanceX = Math.abs(playerX - newBlockerX);
      const distanceY = Math.abs(y - blockerY);
      const collisionThreshold = 40;

      if (distanceX < collisionThreshold && distanceY < collisionThreshold) {
        tagged = true;
      }
    });

    if (tagged) {
      gameEnded = true;
      updatePlayerScore(playerName, currentLevel - 1);
      const gameOver = document.createElement("div");
      gameOver.className = "overlay-card";
      gameOver.innerHTML = `
        <h2>üòµ GAME OVER!</h2>
        <p>You were tagged at Level ${currentLevel}! (Completed: ${Math.max(0, currentLevel - 1)} levels)</p>
        <button class="submit-btn" onclick="location.reload()">üîÅ Restart</button>
        <button id="viewLbAfter" class="submit-btn">üèÜ View Leaderboard</button>
      `;
      document.body.appendChild(gameOver);
      document.getElementById("viewLbAfter")?.addEventListener("click", () => {
        gameOver.remove();
        showLeaderboard();
      });
      return;
    }

    // ‚úÖ Finish line check (pass last blocker)
    if (y < 20 && !gameEnded) {
      gameEnded = true;
      if (currentLevel < maxLevel) {
        // Proceed to next level
        currentLevel++;
        // Reset player
        x = screenW * 0.5;
        y = screenH * 0.85;
        player.style.left = x + "px";
        player.style.top = y + "px";
        // Recreate blockers
        createBlockersForLevel(currentLevel);
        // Update UI
        updatePlayerInfo();
        // Resume
        gameEnded = false;
      } else {
        // Game complete
        updatePlayerScore(playerName, maxLevel);
        const winScreen = document.createElement("div");
        winScreen.className = "overlay-card";
        winScreen.innerHTML = `
          <h2>üéâ YOU WIN!</h2>
          <p>You completed all ${maxLevel} levels!</p>
          <button class="submit-btn" onclick="location.reload()">üîÅ Play Again</button>
          <button id="viewLbWin" class="submit-btn">üèÜ View Leaderboard</button>
        `;
        document.body.appendChild(winScreen);
        document.getElementById("viewLbWin")?.addEventListener("click", () => {
          winScreen.remove();
          showLeaderboard();
        });
      }
    }
  }, 200);
}

function createBlockersForLevel(level) {
  // Remove existing blockers
  blockers.forEach(blk => blk.remove());
  blockers = [];

  for (let i = 0; i < level; i++) {
    const blocker = document.createElement("div");
        blocker.className = "Character";
    blocker.style.left = screenW * 0.5 + "px";
    blocker.style.top = linesY[i] + "px";
    blocker.setAttribute("facing", "down");
    blocker.innerHTML = `
      <img class="Character_shadow pixelart" src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/21542/DemoRpgCharacterShadow.png" />
      <img class="Character_spritesheet pixelart face-down" src="blocker.png" />
    `;
    document.body.appendChild(blocker);
    blockers.push(blocker);
  }
}

function updatePlayerInfo() {
  const playerInfo = document.getElementById("playerInfo");
  if (playerInfo) {
    playerInfo.innerHTML = `${playerName}<br>Level ${currentLevel}/${maxLevel}`;
  }
}
});
</script>
</body>
</html>
