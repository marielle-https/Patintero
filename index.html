<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Patintero Game</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  
</head>
<body>
<!-- Home Screen -->
<div class="overlay-card" id="homeScreen">
  <h2>Patintero</h2>
  <p>
    üèÉ Relive the excitement of a Filipino
    childhood favorite! Cross the lines and avoid the taggers.<br><br>
    üëâ Use <b>ARROW KEYS / WASD</b> on desktop or <b>VIRTUAL JOYSTICK</b> on mobile to move.<br>
    üèÅ Reach the opposite side without being tagged!
  </p>
  <button id="startBtn">‚ñ∂ START GAME</button>
  <button id="leaderboardBtn">üèÜ Leaderboard</button>
</div>

<!-- Level Complete Announcement Overlay -->
<div id="levelCompleteOverlay">
  <h2 id="completeMessage">Level Complete!</h2>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const startBtn = document.getElementById("startBtn");
  const leaderboardBtn = document.getElementById("leaderboardBtn");
  let playerName = '';
  let currentLevel = 1;
  let maxLevel = 5;
  let gameEnded = false;
  let x, y;
  let screenW, screenH;
  let blockers = [];
  let linesY = [];
  let finishLine = null; // finish line element

  // Joystick variables
  let joystickActive = false;
  let joystickCenterX = 0;
  let joystickCenterY = 0;
  let currentDx = 0;
  let currentDy = 0;
  let joystickInterval = null;

  // ApiLeaderboard functions
  function getLeaderboard() {
    return JSON.parse(localStorage.getItem('patinteroLeaderboard') || '[]');
  }

  function saveLeaderboard(leaderboard) {
    localStorage.setItem('patinteroLeaderboard', JSON.stringify(leaderboard));
  }

  function updatePlayerScore(name, levelsCompleted) {
    let lb = getLeaderboard();
    const completed = Math.max(0, levelsCompleted);
    let existing = lb.find(p => p.name.toLowerCase() === name.toLowerCase());
    if (existing) {
      if (completed > existing.levelsCompleted) {
        existing.levelsCompleted = completed;
      }
    } else {
      lb.push({ name: name, levelsCompleted: completed });
    }
    lb.sort((a, b) => b.levelsCompleted - a.levelsCompleted || a.name.localeCompare(b.name));
    saveLeaderboard(lb);
  }

  function showLeaderboard() {
    const lb = getLeaderboard();
    const top10 = lb.slice(0, 10);
    let html = '<h2>üèÜ Leaderboard</h2><p>Top 10 Players by Levels Completed</p><ul>';
    if (top10.length === 0) {
      html += '<li>No scores yet!</li>';
    } else {
      top10.forEach((p, i) => {
        html += `<li>${i + 1}. ${p.name} - ${p.levelsCompleted} Levels</li>`;
      });
    }
    html += '</ul><button class="submit-btn" id="closeLb">Close</button>';
    const lbOverlay = document.createElement("div");
    lbOverlay.className = "overlay-card";
    lbOverlay.id = "lbOverlay";
    lbOverlay.innerHTML = html;
    document.body.appendChild(lbOverlay);
    document.getElementById("closeLb").addEventListener("click", () => {
      lbOverlay.remove();
      const gameOverEl = document.getElementById("gameOverOverlay");
      if (gameOverEl) {
        gameOverEl.style.display = "flex";
      }
      const winEl = document.getElementById("winOverlay");
      if (winEl) {
        winEl.style.display = "flex";
      }
    });
  }

  leaderboardBtn.addEventListener("click", showLeaderboard);

  startBtn.addEventListener("click", () => {
    document.getElementById("homeScreen").style.display = "none";

    // Username Input Overlay
    const nameOverlay = document.createElement("div");
    nameOverlay.className = "overlay-card";
    nameOverlay.id = "nameOverlay";
    nameOverlay.innerHTML = `
      <h2>Enter Player Name</h2>
      <p>To start the game, please enter your username.</p>
      <input id="username" type="text" placeholder="Your Name" maxlength="20">
      <button class="submit-btn" id="submitName">‚ñ∂ START GAME</button>
    `;
    document.body.appendChild(nameOverlay);

    const submitNameBtn = document.getElementById("submitName");
    const usernameInput = document.getElementById("username");

    submitNameBtn.addEventListener("click", () => {
      const name = usernameInput.value.trim();
      if (!name) {
        alert("Please enter a username to start the game!");
        return;
      }
      playerName = name;

      const playerData = {
        name: playerName,
        currentLevel: currentLevel,
        maxLevel: maxLevel
      };
      localStorage.setItem('patinteroPlayer', JSON.stringify(playerData));

      nameOverlay.remove();

      // Initialize Game
      initGame();
    });

    // Allow Enter key for username
    usernameInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        submitNameBtn.click();
      }
    });
  });

  function initGame() {
    screenW = window.innerWidth;
    screenH = window.innerHeight;

    document.body.style.background = "url('playground.png') no-repeat center center fixed";
    document.body.style.backgroundSize = "cover";

    // UI Elements
    const uiLeft = document.createElement("div");
    uiLeft.id = "ui-left";
    uiLeft.className = "top-ui";
    uiLeft.innerHTML = '<div id="playerInfo"></div>';
    document.body.appendChild(uiLeft);

    const uiRight = document.createElement("div");
    uiRight.id = "ui-right";
    uiRight.className = "top-ui";
    uiRight.innerHTML = '<h3>PATINTERO</h3>';
    document.body.appendChild(uiRight);

    updatePlayerInfo();

    // Lines for blockers (from bottom to top)
    linesY = [
      screenH * 0.75,
      screenH * 0.60,
      screenH * 0.45,
      screenH * 0.30,
      screenH * 0.15
    ];

    // player size constant for crossing/collision math
    const PLAYER_SIZE = 64;

    // === PLAYER SPRITE ===
    const player = document.createElement("div");
    player.className = "Character";
    x = screenW * 0.5;
    y = screenH - 100; // start closer to bottom
    player.style.left = x + "px";
    player.style.top = y + "px";
    player.setAttribute("facing", "down");
    player.innerHTML = `
      <img class="Character_shadow pixelart" src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/21542/DemoRpgCharacterShadow.png" />
      <img class="Character_spritesheet pixelart face-down" src="AjFP5.png" />
    `;
    document.body.appendChild(player);

    // Create initial blockers & finish line
    createBlockersForLevel(currentLevel);
    createFinishLine(currentLevel);

    // === JOYSTICK SETUP (for mobile/touch devices) ===
    const joystick = document.createElement('div');
    joystick.id = 'joystick';
    const knob = document.createElement('div');
    knob.id = 'knob';
    joystick.appendChild(knob);
    document.body.appendChild(joystick);

    // Show joystick on touch devices
    if ('ontouchstart' in window) {
      joystick.style.display = 'block';
    }

    // Joystick event handlers
    const joystickElement = document.getElementById('joystick');
    const knobElement = document.getElementById('knob');

    joystickElement.addEventListener('touchstart', (e) => {
      if (gameEnded) return;
      e.preventDefault();
      joystickActive = true;
      const rect = joystickElement.getBoundingClientRect();
      joystickCenterX = rect.left + rect.width / 2;
      joystickCenterY = rect.top + rect.height / 2;
      updateKnob(e.touches[0].clientX, e.touches[0].clientY);
      startJoystickMovement();
    });

    joystickElement.addEventListener('touchmove', (e) => {
      if (!joystickActive || gameEnded) return;
      e.preventDefault();
      updateKnob(e.touches[0].clientX, e.touches[0].clientY);
    });

    joystickElement.addEventListener('touchend', (e) => {
      if (gameEnded) return;
      e.preventDefault();
      joystickActive = false;
      currentDx = 0;
      currentDy = 0;
      knobElement.style.transform = 'translate(-50%, -50%)';
      stopJoystickMovement();
    });

    function updateKnob(touchX, touchY) {
      const deltaX = touchX - joystickCenterX;
      const deltaY = touchY - joystickCenterY;
      const dist = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
      const maxDist = 30; // Max drag distance

      let normalizedDx = 0;
      let normalizedDy = 0;

      if (dist > maxDist) {
        const angle = Math.atan2(deltaY, deltaX);
        const clampedX = Math.cos(angle) * maxDist;
        const clampedY = Math.sin(angle) * maxDist;
        normalizedDx = clampedX / maxDist;
        normalizedDy = clampedY / maxDist;
        knobElement.style.transform = `translate(-50%, -50%) translate(${clampedX}px, ${clampedY}px)`;
      } else {
        normalizedDx = deltaX / maxDist;
        normalizedDy = deltaY / maxDist;
        knobElement.style.transform = `translate(-50%, -50%) translate(${deltaX}px, ${deltaY}px)`;
      }

      currentDx = normalizedDx;
      currentDy = normalizedDy;
    }

    function startJoystickMovement() {
      if (joystickInterval) clearInterval(joystickInterval);
      joystickInterval = setInterval(() => {
        if (!joystickActive || gameEnded) {
          stopJoystickMovement();
          return;
        }
        moveBasedOnJoystick();
      }, 150); // Move every 150ms
    }

    function stopJoystickMovement() {
      if (joystickInterval) {
        clearInterval(joystickInterval);
        joystickInterval = null;
      }
    }

    function moveBasedOnJoystick() {
      if (!joystickActive || gameEnded) return;

      const threshold = 0.3;
      let dx = 0, dy = 0, direction = 'face-down';

      if (Math.abs(currentDx) > threshold || Math.abs(currentDy) > threshold) {
        if (Math.abs(currentDy) > Math.abs(currentDx)) {
          if (currentDy < -threshold) {
            dy = -15;
            direction = 'face-up';
          } else if (currentDy > threshold) {
            dy = 15;
            direction = 'face-down';
          }
        } else {
          if (currentDx < -threshold) {
            dx = -15;
            direction = 'face-left';
          } else if (currentDx > threshold) {
            dx = 15;
            direction = 'face-right';
          }
        }
        movePlayer(dx, dy, direction);
      }
    }

    // === PLAYER MOVEMENT ===
    gameEnded = false;

    function movePlayer(dx, dy, direction) {
      if (gameEnded) return;
      x += dx;
      y += dy;
      // Bounds
      const playerSize = PLAYER_SIZE;
      x = Math.max(0, Math.min(screenW - playerSize, x));
      y = Math.max(0, Math.min(screenH - playerSize, y));
      const sprite = player.querySelector(".Character_spritesheet");
      sprite.className = `Character_spritesheet pixelart ${direction}`;
      player.style.left = x + "px";
      player.style.top = y + "px";
    }

    // Keyboard controls (desktop)
    window.addEventListener("keydown", e => {
      if (gameEnded) return;
      if (e.key === "ArrowLeft" || e.key.toLowerCase() === "a") movePlayer(-15, 0, "face-left");
      if (e.key === "ArrowRight" || e.key.toLowerCase() === "d") movePlayer(15, 0, "face-right");
      if (e.key === "ArrowUp" || e.key.toLowerCase() === "w") movePlayer(0, -15, "face-up");
      if (e.key === "ArrowDown" || e.key.toLowerCase() === "s") movePlayer(0, 15, "face-down");
    });

    // Level Complete Announcement Function
    function showLevelComplete() {
      const overlay = document.getElementById('levelCompleteOverlay');
      const messageEl = document.getElementById('completeMessage');
      messageEl.textContent = `Level ${currentLevel} Complete!`;
      overlay.style.display = 'block';

      setTimeout(() => {
        overlay.style.display = 'none';
        currentLevel++;
        x = screenW * 0.5;
        y = screenH - 100;
        player.style.left = x + "px";
        player.style.top = y + "px";
        createBlockersForLevel(currentLevel);
        createFinishLine(currentLevel);
        updatePlayerInfo();
        gameEnded = false;
      }, 1500); // Show for 1.5 seconds
    }

    // === BLOCKER CHASE + GAME OVER ===
    setInterval(() => {
      if (gameEnded) return;

      // --- FIRST: check finish crossing (priority over collisions) ---
      const targetLineY = linesY[currentLevel - 1];
      const PLAYER_SIZE_CONST = PLAYER_SIZE;
      const playerCenterY = y + PLAYER_SIZE_CONST / 2;

      if (typeof targetLineY !== 'undefined' && playerCenterY <= targetLineY && !gameEnded) {
        // Player has crossed the finish line ‚Äî finish BEFORE blockers can tag
        gameEnded = true;
        if (currentLevel < maxLevel) {
          showLevelComplete();
        } else {
          updatePlayerScore(playerName, maxLevel);
          const winScreen = document.createElement("div");
          winScreen.className = "overlay-card";
          winScreen.id = "winOverlay";
          winScreen.innerHTML = `
            <h2>üéâ YOU WIN!</h2>
            <p>You completed all ${maxLevel} levels!</p>
            <button class="submit-btn" onclick="location.reload()">üîÅ Play Again</button>
            <button id="viewLbWin" class="submit-btn">üèÜ View Leaderboard</button>
          `;
          document.body.appendChild(winScreen);
          document.getElementById("viewLbWin")?.addEventListener("click", () => {
            const winEl = document.getElementById("winOverlay");
            if (winEl) {
              winEl.style.display = "none";
            }
            showLeaderboard();
          });
        }
        return; // don't run blockers logic this tick
      }

      // --- THEN: blockers move and collision checks ---
      const playerX = x;
      let tagged = false;

      blockers.forEach(blk => {
        const blockerX = parseInt(blk.style.left, 10);
        const blockerY = parseInt(blk.style.top, 10);
        const dx = playerX - blockerX;
        const dy = y - blockerY;
        const step = 16; // blocker speed (slightly slower)

        let newBlockerX = blockerX;

        // Blocker moves left/right only
        if (Math.abs(dx) > step) {
          newBlockerX = blockerX + step * Math.sign(dx);
          blk.style.left = newBlockerX + "px";
        }

        // Keep blocker on the line
        blk.style.top = blockerY + "px";

        // Face towards player
        let faceDir;
        if (Math.abs(dy) > Math.abs(dx)) {
          faceDir = dy > 0 ? "face-down" : "face-up";
        } else {
          faceDir = dx > 0 ? "face-right" : "face-left";
        }
        const sprite = blk.querySelector(".Character_spritesheet");
        if (sprite) sprite.className = `Character_spritesheet pixelart ${faceDir}`;

        // Collision detection (using new position)
        const distanceX = Math.abs(playerX - newBlockerX);
        const distanceY = Math.abs(y - blockerY);
        const collisionThreshold = 36; // slightly reduced threshold

        if (distanceX < collisionThreshold && distanceY < collisionThreshold) {
          tagged = true;
        }
      });

      if (tagged) {
        gameEnded = true;
        updatePlayerScore(playerName, currentLevel - 1);
        const gameOver = document.createElement("div");
        gameOver.className = "overlay-card";
        gameOver.id = "gameOverOverlay";
        gameOver.innerHTML = `
          <h2>üòµ GAME OVER!</h2>
          <p>You were tagged at Level ${currentLevel}! (Completed: ${Math.max(0, currentLevel - 1)} levels)</p>
          <button class="submit-btn" onclick="location.reload()">üîÅ Restart</button>
          <button id="viewLbAfter" class="submit-btn">üèÜ View Leaderboard</button>
        `;
        document.body.appendChild(gameOver);
        document.getElementById("viewLbAfter")?.addEventListener("click", () => {
          const gameOverEl = document.getElementById("gameOverOverlay");
          if (gameOverEl) {
            gameOverEl.style.display = "none";
          }
          showLeaderboard();
        });
        return;
      }

      // (Win detection is handled above before blockers logic)
    }, 200);
  } // end initGame

  function createBlockersForLevel(level) {
    blockers.forEach(blk => blk.remove());
    blockers = [];

    for (let i = 0; i < level; i++) {
      const blocker = document.createElement("div");
      blocker.className = "Character";
      blocker.style.left = screenW * 0.5 + "px";
      blocker.style.top = linesY[i] + "px";
      blocker.setAttribute("facing", "down");
      blocker.innerHTML = `
        <img class="Character_shadow pixelart" src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/21542/DemoRpgCharacterShadow.png" />
        <img class="Character_spritesheet pixelart face-down" src="blocker.png" />
      `;
      document.body.appendChild(blocker);
      blockers.push(blocker);
    }
  }

  // FINISH LINE CREATOR
  function createFinishLine(level) {
    if (finishLine) finishLine.remove(); // remove previous line
    finishLine = document.createElement("div");
    finishLine.className = "finish-line";
    finishLine.style.top = Math.round(linesY[level - 1]) + "px";
    document.body.appendChild(finishLine);
  }

  function updatePlayerInfo() {
    const playerInfo = document.getElementById("playerInfo");
    if (playerInfo) {
      playerInfo.innerHTML = `${playerName}<br>Level ${currentLevel}/${maxLevel}`;
    }
  }
});
</script>
</body>
</html>

